<!--
  Eclipse Public License - v 2.0

    THE ACCOMPANYING PROGRAM IS PROVIDED UNDER THE TERMS OF THIS ECLIPSE
    PUBLIC LICENSE ("AGREEMENT"). ANY USE, REPRODUCTION OR DISTRIBUTION
    OF THE PROGRAM CONSTITUTES RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT.
-->

{#include support-layout}
{#content}
<div class="form-card ticket-detail-card" style="margin-bottom: 16px;">
    <h1>{ticket.name}</h1>
    <form method="post" action="{action}">
        <div class="ticket-detail-grid">
            <label>Ticket
                <input type="text" name="ticketName" value="{ticket.name}" readonly>
            </label>
            <label>Company
                <input type="text" value="{ticket.company.name}" readonly>
            </label>
            <label>Category
                {#if editableStatus?? && editableStatus}
                <select name="categoryId">
                    {#for cat in categories}
                        <option value="{cat.id}" {#if ticket.category != null && ticket.category.id == cat.id}selected{/if}>{cat.name}</option>
                    {/for}
                </select>
                {#else}
                    <input type="text" value="{#if ticket.category != null}{ticket.category.name}{#else}-{/if}" readonly>
                {/if}
            </label>
            <label>Entitlement
                {#if ticket.companyEntitlement == null || ticket.companyEntitlement.entitlement == null}
                <input type="text" value="-" readonly>
                {#else}
                <input type="text" value="{ticket.companyEntitlement.entitlement.name}" readonly>
                {/if}
            </label>
            <label>Status
                {#if editableStatus?? && editableStatus}
                    <select name="status" required>
                        <option value="Open" {#if displayStatus == 'Open'}selected{/if}>Open</option>
                        <option value="Assigned" {#if displayStatus == 'Assigned'}selected{/if}>Assigned</option>
                        <option value="In Progress" {#if displayStatus == 'In Progress'}selected{/if}>In Progress</option>
                        <option value="Resolved" {#if displayStatus == 'Resolved'}selected{/if}>Resolved</option>
                        <option value="Closed" {#if displayStatus == 'Closed'}selected{/if}>Closed</option>
                    </select>
                {#else}
                    <input type="text" value="{displayStatus}" readonly>
                {/if}
            </label>
            <label>Level
                {#if ticket.companyEntitlement == null || ticket.companyEntitlement.supportLevel == null}
                <input type="text" value="-" readonly>
                {#else}
                <input type="text" value="{ticket.companyEntitlement.supportLevel.name}" readonly>
                {/if}
            </label>
            <label>External issue
                {#if editableStatus?? && editableStatus}
                    <input type="text" name="externalIssueLink" value="{#if ticket.externalIssueLink != null}{ticket.externalIssueLink}{/if}">
                {#else}
                    {#if ticket.externalIssueLink != null && !ticket.externalIssueLink.isBlank}
                        <a href="{ticket.externalIssueLink}" target="_blank" rel="noopener">{ticket.externalIssueLink}</a>
                    {#else}
                        <input type="text" value="-" readonly>
                    {/if}
                {/if}
            </label>
            <label>TAMs
                {#if tamUsers.isEmpty}
                <input type="text" value="-" readonly>
                {#else}
                <div>
                    {#for user in tamUsers}
                    <a href="{tamUserBase}/{user.id}">{user.name}</a>{#if !user_isLast}, {/if}
                    {/for}
                </div>
                {/if}
            </label>
            <label>Support users
                {#if supportUsers.isEmpty}
                    <input type="text" value="-" readonly>
                {#else}
                    <div>
                        {#for user in supportUsers}
                            <a href="{supportUserBase}/{user.id}">{user.name}</a>{#if !user_isLast}, {/if}
                        {/for}
                    </div>
                {/if}
            </label>
            <label class="ticket-detail-spacer" aria-hidden="true">
                <input type="text" value="-" readonly>
            </label>
        </div>
        {#if editableStatus?? && editableStatus}
        <input type="hidden" name="companyId" value="{ticket.company.id}">
        <input type="hidden" name="companyEntitlementId" value="{ticket.companyEntitlement.id}">
        <div class="form-actions">
            <button type="submit" class="action-button">Save</button>
        </div>
        {/if}
    </form>
</div>

<style>
    .message-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 16px;
    }
    .message-table td {
        border: 1px solid var(--table-border);
        padding: 8px;
        text-align: left;
    }
    .message-table tbody:nth-of-type(even) {
        background-color: #f2f2f2;
    }
    .message-header {
        font-weight: 700;
        background-color: var(--header-bg);
        color: var(--header-text);
    }
    .message-header a {
        color: var(--header-text);
        text-decoration: none;
    }
    .message-table .message-email {
        text-align: right;
    }
    .message-attachments td {
        padding: 0;
    }
    .attachment-footer {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 10px;
        background: rgba(176, 0, 32, 0.06);
        border-top: 1px solid var(--table-border);
    }
    .attachment-meta {
        font-size: 12px;
        color: #5b5b5b;
        margin-left: auto;
        text-align: right;
    }
    .attachment-name {
        text-align: left;
    }
    .attachment-name a {
        color: #b00020;
        text-decoration: none;
        font-weight: 600;
    }
</style>

<h2>Messages</h2>
{#if messages.isEmpty}
<p>No messages yet.</p>
{#else}
<table class="message-table">
    {#for message in messages}
    <tbody>
    <tr class="message-header">
        <td>{messageLabels.get(message.id)}</td>
        <td class="message-email">
            {#if message.author != null}
            {#if messageAuthorLinks.containsKey(message.id)}
            <a href="{messageAuthorLinks.get(message.id)}">{messageAuthorNames.get(message.id)}</a>
            {#else}
            {messageAuthorNames.get(message.id)}
            {/if}
            {#else}
            -
            {/if}
        </td>
    </tr>
    <tr>
        <td colspan="2">
            <div class="markdown-output">{message.body.markdown}</div>
        </td>
    </tr>
    {#if !message.attachments.isEmpty}
    <tr class="message-attachments">
        <td colspan="2">
            {#for attachment in message.attachments}
            <div class="attachment-footer">
                <span class="attachment-name">
                    <a href="/attachments/{attachment.id}" target="_blank" rel="noopener">{attachment.name}</a>
                </span>
                <span class="attachment-meta">{attachment.mimeType} - {attachment.sizeLabel}</span>
            </div>
            {/for}
        </td>
    </tr>
    {/if}
    </tbody>
    {/for}
</table>
{/if}

<h2>Reply</h2>
<form method="post" action="{messageAction}" enctype="multipart/form-data">
    <div>
        <div class="markdown-editor" data-markdown-editor>
            <div class="markdown-toolbar" data-md-toolbar>
                <button type="button" data-md-action="bold" aria-label="Bold"><strong>B</strong></button>
                <button type="button" data-md-action="italic" aria-label="Italic"><em>I</em></button>
                <button type="button" data-md-action="heading" aria-label="Heading">H</button>
                <button type="button" data-md-action="list" aria-label="List">List</button>
                <button type="button" data-md-action="quote" aria-label="Quote">Quote</button>
                <button type="button" data-md-action="code" aria-label="Code"><code>{}</code></button>
                <button type="button" data-md-action="code-block" aria-label="Code block">Code</button>
                <button type="button" data-md-action="link" aria-label="Link">Link</button>
            </div>
            <div class="markdown-panels">
                <div class="markdown-panel">
                    <div class="markdown-panel-header">Write</div>
                    <textarea id="support-reply-body" name="body" rows="6" required data-md-input></textarea>
                </div>
                <div class="markdown-panel">
                    <div class="markdown-panel-header">Preview</div>
                    <div class="markdown-preview" data-md-preview></div>
                </div>
            </div>
        </div>
    </div>
    <div data-attachment-container>
        <span class="attachment-label">Attachments</span>
        <div class="attachment-list" data-attachment-list>
            <table>
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Mimetype</th>
                    <th>Size</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <input type="file" name="attachments" multiple data-attachment-input class="attachment-input">
        <div class="form-actions attachment-actions">
            <button type="button" class="action-button" data-attachment-trigger>Browse</button>
            <button type="submit" class="action-button">Add</button>
        </div>
    </div>
</form>
{/content}
{/include}
