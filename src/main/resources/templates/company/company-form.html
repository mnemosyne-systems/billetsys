<!--
  Eclipse Public License - v 2.0

    THE ACCOMPANYING PROGRAM IS PROVIDED UNDER THE TERMS OF THIS ECLIPSE
    PUBLIC LICENSE ("AGREEMENT"). ANY USE, REPRODUCTION OR DISTRIBUTION
    OF THE PROGRAM CONSTITUTES RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT.
-->

{#include admin-layout}
    {#content}
        <div class="form-card" style="max-width: 980px;">
            <h1>{title}</h1>
            <form method="post" action="{action}" onsubmit="selectAll('selectedUsers'); selectAll('selectedTams'); syncEntitlementHidden()">
                <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 24px; align-items: start;">
                    <div>
                        <h4>Company</h4>
                        <div>
                            <label>Name
                                <input type="text" name="name" value="{company.name}" required>
                            </label>
                        </div>
                        <div>
                            <label>Address1
                                <input type="text" name="address1" value="{company.address1}">
                            </label>
                        </div>
                        <div>
                            <label>Address2
                                <input type="text" name="address2" value="{company.address2}">
                            </label>
                        </div>
                        <div>
                            <label>City
                                <input type="text" name="city" value="{company.city}">
                            </label>
                        </div>
                        <div>
                            <label>State
                                <input type="text" name="state" value="{company.state}">
                            </label>
                        </div>
                        <div>
                            <label>Zip
                                <input type="text" name="zip" value="{company.zip}">
                            </label>
                        </div>
                        <div>
                            <label>Phone Number
                                <input type="text" name="phoneNumber" value="{company.phoneNumber}">
                            </label>
                        </div>
                        <div>
                            <label>Country
                                    {#countrySelect selectedCountry=company.country countries=countries /}
                            </label>
                        </div>
                        <div>
                            <label>Time Zone
                                    {#timezoneSelect selectedTimezone=company.timezone timezones=timezones /}
                            </label>
                        </div>
                    <div style="display: grid; gap: 24px; margin-top: 15px">
                        <div>
                            <label style="font-weight: 600;">Entitlements</label>
                            <div style="display: grid; gap: 12px;">
                                <div>
                                    <select id="entitlementPairs" multiple size="6" style="width: 100%;">
                                        {#for entry in companyEntitlements}
                                            <option value="{entry.entitlement.id}:{entry.supportLevel.id}">{entry.entitlement.name} - {entry.supportLevel.name}</option>
                                        {/for}
                                    </select>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="secondary-button" onclick="removeSelectedEntitlement()">Remove</button>
                                </div>
                                <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) auto; gap: 12px; align-items: end;">
                                    <div>
                                        <label style="font-weight: 600;">Entitlement</label>
                                        <select id="entitlementPicker">
                                            <option value="">Select entitlement</option>
                                            {#for entitlement in entitlements}
                                                <option value="{entitlement.id}">{entitlement.name}</option>
                                            {/for}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600;">Level</label>
                                        <select id="supportLevelPicker">
                                            {#for level in supportLevels}
                                                <option value="{level.id}">{level.name}</option>
                                            {/for}
                                        </select>
                                    </div>
                                    <button type="button" class="secondary-button" onclick="addEntitlementPair()">Add</button>
                                </div>
                                <div id="entitlementHidden"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: grid; grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr); gap: 12px; align-items: start;">
                                <div>
                                    <label style="font-weight: 600;">Users available</label>
                                    <select id="availableUsers" multiple size="10" style="width: 100%;">
                                        {#for user in users}
                                            {#if !selectedUserIds.contains(user.id)}
                                                <option value="{user.id}">{user.name}</option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                                <div style="display: grid; gap: 8px;">
                                    <button type="button" class="secondary-button" onclick="moveSelected('availableUsers', 'selectedUsers')">→</button>
                                    <button type="button" class="secondary-button" onclick="moveSelected('selectedUsers', 'availableUsers')">←</button>
                                </div>
                                <div>
                                    <label style="font-weight: 600;">Company users</label>
                                    <select id="selectedUsers" name="userIds" multiple size="10" style="width: 100%;">
                                        {#for user in users}
                                            {#if selectedUserIds.contains(user.id)}
                                                <option value="{user.id}" {#if primaryContact != null &&
                                                user.id == primaryContact.id} disabled {/if}>{user.name} </option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: grid; grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr); gap: 12px; align-items: start;">
                                <div>
                                    <label style="font-weight: 600;">TAMs available</label>
                                    <select id="availableTams" multiple size="10" style="width: 100%;">
                                        {#for tam in tams}
                                            {#if !selectedTamIds.contains(tam.id)}
                                                <option value="{tam.id}">{tam.name}</option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                                <div style="display: grid; gap: 8px;">
                                    <button type="button" class="secondary-button" onclick="moveSelected('availableTams', 'selectedTams')">→</button>
                                    <button type="button" class="secondary-button" onclick="moveSelected('selectedTams', 'availableTams')">←</button>
                                </div>
                                <div>
                                    <label style="font-weight: 600;">Company TAMs</label>
                                    <select id="selectedTams" name="tamIds" multiple size="10" style="width: 100%;">
                                        {#for tam in tams}
                                            {#if selectedTamIds.contains(tam.id)}
                                                <option value="{tam.id}">{tam.name}</option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div>
                        <h4>Primary Contact</h4>
                        {#if primaryContact.id == null}
                            <div>
                                <label> Username
                                    <input type="text" name="primaryContactUsername" value="{primaryContact.name}" required>
                                </label>
                            </div>
                            <div>
                                <label>Full Name
                                    <input type="text" name="primaryContactFullName" value="{primaryContact.fullName}">
                                </label>
                            </div>
                            <div>
                                <label> Email
                                    <input type="text" name="primaryContactEmail" value="{primaryContact.email}" required>
                                </label>
                            </div>
                            <div>
                                <label>Social
                                    <input type="text" name="primaryContactSocial" value="{primaryContact.social}">
                                </label>
                            </div>
                            <div>
                                <label> Phone Number
                                    <input type="text" name="primaryContactPhoneNumber"
                                           value="{primaryContact.phoneNumber}">
                                </label>
                            </div>
                            <div>
                                <label> Phone Number Extension
                                    <input type="text" name="primaryPhoneNumberExtension"
                                           value="{primaryContact.phoneExtension}">
                                </label>
                            </div>
                            <div>
                                <label> Country
                                        {#countrySelect customId="primaryContactCountry" customName="primaryContactCountry"
                                        selectedCountry=primaryContact.country countries=countries /}
                                </label>
                            </div>
                            <div>
                                <label>Time Zone
                                        {#timezoneSelect customName="primaryContactTimeZone" customId="primaryContactTimeZone"
                                        selectedTimezone=primaryContact.timezone timezones=timezones /}
                                </label>
                            </div>
                            <div>
                                <label>
                                    Password
                                    <input type="password" name="primaryContactPassword" {#if primaryContact.id == null}required{/if}>
                                    {#if primaryContact.id != null}
                                        <small>Leave blank to keep the current password.</small>
                                    {/if}
                                </label>
                            </div>
                        {#else}
                            <label>Select from users
                            <select style="width: 100%;" name="primaryContact">
                                {#for user in users}
                                    {#if selectedUserIds.contains(user.id)}
                                        <option value="{user.id}" {#if user.id == primaryContact.id} selected {/if}>{user.name}</option>
                                    {/if}
                                {/for}
                            </select>
                            </label>
                        {/if}
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-button">Save</button>
                </div>
            </form>
        </div>

        <script>
            function moveSelected(sourceId, targetId) {
                const source = document.getElementById(sourceId);
                const target = document.getElementById(targetId);
                const selected = Array.from(source.selectedOptions);
                selected.forEach(option => {
                    source.removeChild(option);
                    option.selected = false;
                    target.appendChild(option);
                });
            }

            function selectAll(selectId) {
                const select = document.getElementById(selectId);
                if (!select) {
                    return;
                }
                Array.from(select.options).forEach(option => {
                    option.disabled = false;
                    option.selected = true;
                });
            }

            function addEntitlementPair() {
                const entitlementPicker = document.getElementById('entitlementPicker');
                const levelPicker = document.getElementById('supportLevelPicker');
                const list = document.getElementById('entitlementPairs');
                if (!entitlementPicker || !levelPicker || !list) {
                    return;
                }
                if (!entitlementPicker.value || !levelPicker.value) {
                    return;
                }
                const value = entitlementPicker.value + ':' + levelPicker.value;
                const exists = Array.from(list.options).some(option => option.value === value);
                if (exists) {
                    return;
                }
                const entitlementText = entitlementPicker.options[entitlementPicker.selectedIndex].textContent;
                const levelText = levelPicker.options[levelPicker.selectedIndex].textContent;
                const option = document.createElement('option');
                option.value = value;
                option.textContent = entitlementText + ' - ' + levelText;
                list.appendChild(option);
                entitlementPicker.selectedIndex = 0;
                levelPicker.selectedIndex = 0;
            }

            function removeSelectedEntitlement() {
                const list = document.getElementById('entitlementPairs');
                if (!list) {
                    return;
                }
                const selected = Array.from(list.selectedOptions);
                selected.forEach(option => option.remove());
            }

            function syncEntitlementHidden() {
                const list = document.getElementById('entitlementPairs');
                const container = document.getElementById('entitlementHidden');
                if (!list || !container) {
                    return;
                }
                container.innerHTML = '';
                Array.from(list.options).forEach(option => {
                    const [entitlementId, levelId] = option.value.split(':');
                    if (!entitlementId || !levelId) {
                        return;
                    }
                    const entitlementInput = document.createElement('input');
                    entitlementInput.type = 'hidden';
                    entitlementInput.name = 'entitlementIds';
                    entitlementInput.value = entitlementId;
                    container.appendChild(entitlementInput);
                    const levelInput = document.createElement('input');
                    levelInput.type = 'hidden';
                    levelInput.name = 'levelIds';
                    levelInput.value = levelId;
                    container.appendChild(levelInput);
                });
            }

            function loadTimezones(select) {
                const target = select.id;
                var countryId = document.getElementById(select.id).value;
                var tzSelect = target === 'primaryContactCountry' ? document.getElementById('primaryContactTimeZone') : document.getElementById('timezoneSelect');
                tzSelect.innerHTML = '<option value="">Select time zone</option>';
                if (!countryId) return;
                fetch('/timezones?countryId=' + countryId)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        for (var i = 0; i < data.length; i++) {
                            var opt = document.createElement('option');
                            opt.value = data[i].id;
                            opt.textContent = data[i].name;
                            tzSelect.appendChild(opt);
                        }
                        if (data.length === 1) {
                            tzSelect.options[1].selected = true;
                        }
                    });
            }
        </script>
    {/content}
{/include}
